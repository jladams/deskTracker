---
title: "RIS Desk Tracker"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    style: styles.css 
runtime: shiny
---

```{r}
source("../R/prep.R")
```

Sidebar {.sidebar}
=======================================================================

### Select Filters

```{r}
dateRangeInput("dates", label = h4("Dates"), start = Sys.Date()-30, end = Sys.Date())
textOutput("dateValidate")

checkboxGroupInput("mode", label = h4("Mode of Interaction"), choices = c(unique(factor(df1$mode) %>% na.omit() %>% as.vector())), selected = c(unique(factor(df1$mode) %>% na.omit() %>% as.vector())))

checkboxGroupInput("type", label = h4("Type of Interaction"), choices = c(unique(factor(df1$type) %>% na.omit() %>% as.vector())), selected = c(unique(factor(df1$type) %>% na.omit() %>% as.vector())))

checkboxGroupInput("referral", label = h4("Referral"), choices = c(unique(factor(df1$referral) %>% na.omit() %>% as.vector())), selected = c(unique(factor(df1$referral) %>% na.omit() %>% as.vector())))

checkboxGroupInput("term", label = h4("Academic Term"), choices = c(unique(factor(df1$term) %>% na.omit() %>% as.vector())), selected = c(unique(factor(df1$term) %>% na.omit() %>% as.vector())))

radioButtons("calculation", label = h4("Calculation to Use"), choices = c("Sum" = "sum", "Mean" = "mean", "Median" = "median", "Max" = "max", "Min" = "min"), selected = "mean")
```

Overview
=======================================================================
```{r}
heatData <- function(x) {
  df <- df() %>%
    group_by_(x, day = "as.Date(date_time)", weekday = "lubridate::wday(date_time, label = TRUE)", hour = "lubridate::hour(date_time)") %>%
    summarize(value = sum(value)) %>%
    group_by_(x, "weekday", "hour") %>%
    summarize(value = calc()(value))
  return(df)
}

barsData <- function(x) {
    df <- df() %>%
    group_by_(x, day = "as.Date(date_time)", weekday = "lubridate::wday(date_time, label = TRUE)") %>%
    summarize(value = sum(value)) %>%
    group_by_(x, "weekday") %>%
    summarize(value = calc()(value)) %>%
    filter(mode != "NA")
}
```

Row
-----------------------------------------------------------------------
### Heatmap
```{r}
plotOutput("testHeat")

output$testHeat <- renderPlot({plotBars(barsData("mode"), "mode")})
```

Row
-----------------------------------------------------------------------
### Bars

```{r}

```

By Mode of Interaction
=======================================================================
```{r}
dfMode <- reactive({
  df <- df() %>%
    group_by(mode, day = as.Date(date_time), weekday = wday(date_time, label = TRUE), hour = hour(date_time)) %>%
    summarize(value = sum(value)) %>%
    group_by(mode, weekday, hour) %>%
    summarize(value = calc()(value))
})

dfModeBars <- reactive(  
  df <- df() %>%
    group_by(mode, day = as_date(date_time), weekday = wday(date_time, label = TRUE)) %>%
    summarize(value = sum(value)) %>%
    group_by(mode, weekday) %>%
    summarize(value = calc()(value)) %>%
    filter(mode != "NA")
)

```

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Heatmap
```{r}
plotOutput("modeHeat")

output$modeHeat <- renderPlot({plotHeat(heatData("mode"))})

```

### Bar Chart
```{r}
plotOutput("modeBars")

output$modeBars <- renderPlot({plotBars(barsData("mode"), "mode")})
```

Row
-----------------------------------------------------------------------
### Data

```{r}
output$modeHeatData <- renderDataTable({heatData("mode")})

dataTableOutput("modeHeatData")
```

By Type of Interaction
=======================================================================

```{r}
dfType <- reactive({
  df <- df() %>%
    group_by(type, day = as.Date(date_time), weekday = wday(date_time, label = TRUE), hour = hour(date_time)) %>%
    summarize(value = sum(value)) %>%
    group_by(type, weekday, hour) %>%
    summarize(value = calc()(value))
})

dfTypeBars <- reactive(  
  df <- df() %>%
    group_by(type, day = as_date(date_time), weekday = wday(date_time, label = TRUE)) %>%
    summarize(value = sum(value)) %>%
    group_by(type, weekday) %>%
    summarize(value = calc()(value)) %>%
    filter(type != "NA")
)
```

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Heatmap
```{r}
plotOutput("typeHeat")

output$typeHeat <- renderPlot({plotHeat(dfType())})

```

### Bar Chart
```{r}
plotOutput("typeBars")

output$typeBars <- renderPlot({plotBars(dfTypeBars(), "type")})
```

Row
-----------------------------------------------------------------------
### Data

```{r}

output$typeHeatData <- renderDataTable({dfType()})
dataTableOutput("typeHeatData")
```

By Referral
=======================================================================

```{r}
dfRef <- reactive({
  df <- df() %>%
    group_by(referral, day = as.Date(date_time), weekday = wday(date_time, label = TRUE), hour = hour(date_time)) %>%
    summarize(value = sum(value)) %>%
    group_by(referral, weekday, hour) %>%
    summarize(value = calc()(value))
})

dfRefBars <- reactive(  
  df <- df() %>%
    group_by(referral, day = as_date(date_time), weekday = wday(date_time, label = TRUE)) %>%
    summarize(value = sum(value)) %>%
    group_by(referral, weekday) %>%
    summarize(value = calc()(value)) %>%
    filter(referral != "NA")
)
```

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Heatmap
```{r}
plotOutput("refHeat")

output$refHeat <- renderPlot({plotHeat(dfRef())})

```

### Bar Chart
```{r}
plotOutput("refBars")

output$refBars <- renderPlot({plotBars(dfRefBars(), "referral")})
```

Row
-----------------------------------------------------------------------
### Data

```{r}

output$refHeatData <- renderDataTable({dfRef()})
dataTableOutput("refHeatData")
```


Raw Data
=======================================================================

Row
-----------------------------------------------------------------------
### Raw Data
```{r}
output$df <- renderDataTable(df())
dataTableOutput("df")
```


```{r}
plotHeat <- function(df) {
  p <- ggplot(data = df, aes(x = hour, y = weekday))
  p <- p +
    geom_tile(aes(fill = value), color = "black") +
    scale_fill_gradient(low="white", high="steelblue", guide=guide_colorbar(title=expression(paste("Number of Interactions")))) +
    labs(x="Hour", y="Weekday")
  return(p)
}

plotBars <- function(df, fillGroup){
  p <- ggplot(data = df, aes(x = weekday, y = value))
  p <- p +
    geom_bar(aes_string(fill = fillGroup), stat = "identity", position = "dodge") +
    geom_text(aes_string(label = quote(round(value, 2)), group = fillGroup), position = position_dodge(width = 1), vjust = 0) + 
    scale_fill_discrete(guide = guide_legend(title = "Mode of Interaction")) +
    labs(x = "Weekday", y = "Number of Interactions")
  return(p)
}

calc <- reactive({ calc <- match.fun(as.character(input$calculation)) })

df <- reactive({
  df <- df1 %>%
    filter(as.Date(date_time) >= as.Date(input$dates[1]) & as.Date(date_time) <= as.Date(input$dates[2])) %>%
    filter(mode %in% input$mode & type %in% input$type & term %in% input$term & referral %in% input$referral)
})

output$dateValidate <- renderText({validate(need(input$dates[2] >= input$dates[1], "End Date is earlier than Start Date."))})



```